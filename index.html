<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš— ä¸Šè½¦å§ - æ™ºèƒ½ä¸Šè½¦ç‚¹è¯„ä¼°</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .camera-box {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary {
            background: linear-gradient(45deg, #2196F3, #0b7dda);
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .score {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .safe { color: #4CAF50; }
        .warning { color: #FFC107; }
        .danger { color: #F44336; }
        
        .recommendation {
            text-align: center;
            font-size: 1.1rem;
            margin: 10px 0;
        }
        
        .objects-list {
            margin-top: 10px;
        }
        
        .object-tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.9rem;
        }
        
        .qrcode-section {
            text-align: center;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš— ä¸Šè½¦å§</h1>
            <p class="subtitle">æ™ºèƒ½ä¸Šè½¦ç‚¹å®‰å…¨è¯„ä¼°</p>
        </header>
        
        <div class="camera-box">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="secondary">å¼€å¯æ‘„åƒå¤´</button>
            <button id="analyzeBtn" disabled>åˆ†æå®‰å…¨åº¦</button>
        </div>
        
        <div class="result-card" id="result" style="display: none;">
            <h3>å®‰å…¨è¯„ä¼°ç»“æœ</h3>
            <div class="score" id="score">--</div>
            <div class="recommendation" id="recommendation">åˆ†æä¸­...</div>
            
            <div class="objects-list" id="objects">
                <!-- æ£€æµ‹åˆ°çš„ç‰©ä½“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            
            <div class="qrcode-section">
                <h4>ä½ç½®åˆ†äº«ç </h4>
                <div id="qrcode"></div>
                <p style="margin-top: 8px; font-size: 0.9rem;">å¸æœºæ‰«æå³å¯æ‰¾åˆ°æ‚¨</p>
            </div>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>AIæ­£åœ¨åˆ†æç¯å¢ƒ...</p>
        </div>
        
        <footer>
            <p>æ™ºæ…§äº¤é€šå¯¼è®ºé¡¹ç›® | åŸºäºAIçš„æ™ºèƒ½å®‰å…¨è¯„ä¼°</p>
        </footer>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const result = document.getElementById('result');
        const loading = document.getElementById('loading');
        const scoreElement = document.getElementById('score');
        const recommendationElement = document.getElementById('recommendation');
        const objectsElement = document.getElementById('objects');
        
        let model = null;
        let stream = null;
        
        // å¼€å¯æ‘„åƒå¤´
        startBtn.addEventListener('click', async () => {
            try {
                startBtn.textContent = 'å¼€å¯ä¸­...';
                startBtn.disabled = true;
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                video.srcObject = stream;
                analyzeBtn.disabled = false;
                startBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
                
                // åŠ è½½AIæ¨¡å‹
                loading.style.display = 'block';
                model = await cocoSsd.load();
                loading.style.display = 'none';
                
            } catch (err) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆæƒæ‘„åƒå¤´æƒé™');
                startBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
                startBtn.disabled = false;
            }
        });
        
        // åˆ†æå®‰å…¨åº¦
        analyzeBtn.addEventListener('click', async () => {
            if (!model) {
                alert('AIæ¨¡å‹å°šæœªåŠ è½½å®Œæˆ');
                return;
            }
            
            loading.style.display = 'block';
            result.style.display = 'none';
            analyzeBtn.disabled = true;
            
            try {
                // ä½¿ç”¨AIæ¨¡å‹æ£€æµ‹ç‰©ä½“
                const predictions = await model.detect(video);
                
                // åˆ†æå®‰å…¨åº¦
                const safetyResult = analyzeSafety(predictions);
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(safetyResult, predictions);
                
                // ç”ŸæˆäºŒç»´ç 
                generateQRCode();
                
            } catch (err) {
                alert('åˆ†æå¤±è´¥: ' + err.message);
            } finally {
                loading.style.display = 'none';
                result.style.display = 'block';
                analyzeBtn.disabled = false;
            }
        });
        
        // åˆ†æå®‰å…¨åº¦å‡½æ•°
        function analyzeSafety(predictions) {
            let safetyScore = 100;
            
            // ç‰©ä½“æƒé‡é…ç½®
            const objectWeights = {
                'person': -3,       // è¡Œäºº
                'car': -8,          // å°æ±½è½¦
                'truck': -12,       // å¡è½¦
                'bus': -15,         // å…¬äº¤è½¦
                'motorcycle': -10,  // æ‘©æ‰˜è½¦
                'bicycle': -5,      // è‡ªè¡Œè½¦
                'traffic light': 5, // äº¤é€šç¯
                'stop sign': 8,     // åœæ­¢æ ‡å¿—
                'parking meter': 12 // åœè½¦è®¡æ—¶å™¨
            };
            
            // è®¡ç®—å®‰å…¨åˆ†æ•°
            predictions.forEach(prediction => {
                const className = prediction.class;
                if (objectWeights[className] !== undefined) {
                    safetyScore += objectWeights[className];
                }
            });
            
            // é™åˆ¶åˆ†æ•°èŒƒå›´
            safetyScore = Math.max(0, Math.min(100, safetyScore));
            
            // æ ¹æ®åˆ†æ•°ç»™å‡ºå»ºè®®
            let recommendation = '';
            let level = '';
            
            if (safetyScore >= 75) {
                level = 'safe';
                recommendation = 'âœ… å®‰å…¨çš„ä¸Šè½¦ç‚¹ï¼Œå¯åœ¨æ­¤ç­‰å¾…';
            } else if (safetyScore >= 50) {
                level = 'warning';
                recommendation = 'âš ï¸ ä½ç½®ä¸€èˆ¬ï¼Œå»ºè®®å¯»æ‰¾æ›´å®‰å…¨ä½ç½®';
            } else {
                level = 'danger';
                recommendation = 'âŒ å±é™©ä½ç½®ï¼è¯·ç«‹å³ç§»åŠ¨åˆ°å®‰å…¨åŒºåŸŸ';
            }
            
            return {
                score: Math.round(safetyScore),
                recommendation: recommendation,
                level: level
            };
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(safetyResult, predictions) {
            scoreElement.textContent = safetyResult.score;
            scoreElement.className = 'score ' + safetyResult.level;
            recommendationElement.textContent = safetyResult.recommendation;
            
            // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„ç‰©ä½“
            objectsElement.innerHTML = '<h4>æ£€æµ‹åˆ°çš„ç‰©ä½“:</h4>';
            if (predictions.length === 0) {
                objectsElement.innerHTML += '<p>æœªæ£€æµ‹åˆ°æ˜æ˜¾ç‰©ä½“</p>';
            } else {
                predictions.forEach(prediction => {
                    const objectTag = document.createElement('span');
                    objectTag.className = 'object-tag';
                    objectTag.textContent = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                    objectsElement.appendChild(objectTag);
                });
            }
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const locationId = 'LOC-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            const locationText = `ä¸Šè½¦ç‚¹ä½ç½®ç : ${locationId}\næ—¶é—´: ${new Date().toLocaleTimeString()}`;
            
            // æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç 
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            // ç”Ÿæˆæ–°äºŒç»´ç 
            QRCode.toCanvas(locationText, { 
                width: 120, 
                height: 120,
                margin: 1
            }, function(err, canvas) {
                if (err) {
                    console.error(err);
                    qrcodeContainer.innerHTML = '<p>äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>';
                    return;
                }
                qrcodeContainer.appendChild(canvas);
            });
        }
    </script>
</body>
</html>
