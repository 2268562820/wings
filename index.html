<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šè½¦å§ - æ™ºèƒ½ä¸Šè½¦ç‚¹æ¨è</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(0,0,0,0.7); border-radius: 20px; padding: 20px; }
        h1 { text-align: center; margin-bottom: 20px; color: #ff8a00; }
        .camera-container { width: 100%; height: 300px; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 8px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        .result { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 20px; }
        .score { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
        .safe { color: #4CAF50; }
        .warning { color: #FFC107; }
        .danger { color: #F44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— ä¸Šè½¦å§ - æ™ºèƒ½ä¸Šè½¦ç‚¹è¯„ä¼°</h1>
        
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <button id="startBtn">å¼€å¯æ‘„åƒå¤´</button>
        <button id="analyzeBtn" disabled>åˆ†æå®‰å…¨åº¦</button>
        
        <div class="result" id="result" style="display: none;">
            <h2>å®‰å…¨è¯„ä¼°ç»“æœ</h2>
            <div class="score" id="score">--</div>
            <p id="recommendation">æ­£åœ¨åˆ†æä¸­...</p>
            <div id="objects"></div>
            <div id="qrcode" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const result = document.getElementById('result');
        const scoreElement = document.getElementById('score');
        const recommendationElement = document.getElementById('recommendation');
        const objectsElement = document.getElementById('objects');
        
        let model = null;
        
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                analyzeBtn.disabled = false;
                startBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
                startBtn.disabled = true;
                
                // åŠ è½½AIæ¨¡å‹
                model = await cocoSsd.load();
                
            } catch (err) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + err.message);
            }
        });
        
        analyzeBtn.addEventListener('click', async () => {
            if (!model) return;
            
            const predictions = await model.detect(video);
            const safetyResult = analyzeSafety(predictions);
            displayResults(safetyResult, predictions);
            generateQRCode();
        });
        
        function analyzeSafety(predictions) {
            let safetyScore = 100;
            const objectWeights = {
                'person': -5, 'car': -10, 'truck': -15, 'bus': -20,
                'traffic light': 5, 'stop sign': 10, 'parking meter': 15,
            };
            
            predictions.forEach(prediction => {
                if (objectWeights[prediction.class] !== undefined) {
                    safetyScore += objectWeights[prediction.class];
                }
            });
            
            safetyScore = Math.max(0, Math.min(100, safetyScore));
            
            let recommendation = '';
            let level = '';
            
            if (safetyScore >= 70) {
                level = 'safe';
                recommendation = 'âœ… å®‰å…¨çš„ä¸Šè½¦ç‚¹';
            } else if (safetyScore >= 40) {
                level = 'warning';
                recommendation = 'âš ï¸ ä¸€èˆ¬ä½ç½®ï¼Œå»ºè®®å¯»æ‰¾æ›´å®‰å…¨ä½ç½®';
            } else {
                level = 'danger';
                recommendation = 'âŒ å±é™©ä½ç½®ï¼Œè¯·ç«‹å³ç§»åŠ¨';
            }
            
            return { score: safetyScore, recommendation: recommendation, level: level };
        }
        
        function displayResults(safetyResult, predictions) {
            scoreElement.textContent = safetyResult.score;
            scoreElement.className = 'score ' + safetyResult.level;
            recommendationElement.textContent = safetyResult.recommendation;
            
            objectsElement.innerHTML = '<h3>æ£€æµ‹åˆ°çš„ç‰©ä½“:</h3>';
            predictions.forEach(prediction => {
                objectsElement.innerHTML += `<div>${prediction.class} (${Math.round(prediction.score * 100)}%)</div>`;
            });
            
            result.style.display = 'block';
        }
        
        function generateQRCode() {
            const locationId = Math.random().toString(36).substring(2, 10).toUpperCase();
            const locationText = `ä¸Šè½¦ç‚¹ä½ç½®ç : ${locationId}\næ—¶é—´: ${new Date().toLocaleString()}`;
            
            QRCode.toCanvas(locationText, { width: 150, height: 150 }, function(err, canvas) {
                if (!err) {
                    document.getElementById('qrcode').innerHTML = '<h3>ä½ç½®äºŒç»´ç :</h3>';
                    document.getElementById('qrcode').appendChild(canvas);
                }
            });
        }
    </script>
</body>
</html>
