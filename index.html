<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceMood Live (阿里ASR版)</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; background: #f0f8ff; }
    h1 { color: #007acc; }
    #mic { font-size: 60px; cursor: pointer; user-select: none; }
    #status { font-size: 18px; margin: 20px; color: #555; }
    #log { margin: 20px auto; max-width: 90%; text-align: left; border: 1px solid #ddd; padding: 10px; border-radius: 8px; max-height: 400px; overflow-y: auto; background: white; }
    .user { color: #333; margin: 8px 0; }
    .ai { color: #007acc; margin: 8px 0; font-weight: bold; }
    .system { color: #888; font-style: italic; }
    .error { color: red; }
    #nav { margin: 20px; }
    .btn { padding: 12px 24px; font-size: 18px; background: #007acc; color: white; text-decoration: none; border-radius: 8px; display: inline-block; }
  </style>
</head>
<body>
  <h1>VoiceMood Live</h1>
  <p>按住麦克风说话，我陪你</p>
  
  <div id="mic">麦克风</div>
  <div id="status">等待录音...</div>
  <div id="log"></div>
  <div id="nav"></div>

  <script>
    // === API Key 贴这里 ===
    const API_KEY = 'sk-550f45f609c5430d81ac382c31a4fccb'; // ←←← 替换这里！

    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let lastSpeechTime = Date.now();
    let careTimer = null;

    const mic = document.getElementById('mic');
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const nav = document.getElementById('nav');
    const synth = window.speechSynthesis;

    const TRIGGER_WORDS = ['开始测试', '去湖边', '好累', '导航', '去哪', '难受', '冷静', '开车', '助手', '帮我', '我想去'];
    const CARE_INTERVAL = 30000; // 30秒

    // 添加日志
    function addLog(speaker, text, className = '') {
      const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      const div = document.createElement('div');
      div.className = className;
      div.innerHTML = `<small>${time}</small> <strong>${speaker}：</strong>${text}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    // 30秒没说话，关心你
    function startCareTimer() {
      clearTimeout(careTimer);
      careTimer = setTimeout(() => {
        const careMsg = "还活着吗？我在呢，说句话吧。";
        addLog('AI', careMsg);
        speak(careMsg);
      }, CARE_INTERVAL);
    }

    // 开始录音
    mic.addEventListener('mousedown', startRecording);
    mic.addEventListener('touchstart', startRecording);
    mic.addEventListener('mouseup', stopRecording);
    mic.addEventListener('touchend', stopRecording);

    async function startRecording() {
      if (isRecording) return;
      isRecording = true;
      status.innerText = '正在录音...';
      addLog('系统', '录音启动');
      startCareTimer();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
      };
    }

    async function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      mediaRecorder.stop();
      status.innerText = '处理中...';
      addLog('系统', '录音停止，处理语音...');

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioBase64 = await blobToBase64(audioBlob);
        const text = await recognizeSpeech(audioBase64);
        addLog('你', text);
        if (TRIGGER_WORDS.some(word => text.toLowerCase().includes(word))) {
          addLog('系统', '检测到关键词：' + text.substring(0, 20) + '...');
          const reply = await callBailianAI(text);
          addLog('AI', reply);
          speak(reply);
          extractAndNavigate(reply);
        }
        lastSpeechTime = Date.now();
        startCareTimer();
      };
    }

    // blob转base64
    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
      });
    }

    // 阿里百炼 ASR
    async function recognizeSpeech(base64) {
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/asr', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'paraformer-zh',
            audio: base64
          })
        });
        const data = await response.json();
        return data.result.text || "没听到，说清楚点。";
      } catch (e) {
        addLog('系统', 'ASR 失败：' + e.message, 'error');
        return "没听到，说清楚点。";
      }
    }

    // 调用阿里百炼 LLM
    async function callBailianAI(text) {
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            input: {
              messages: [
                { role: 'system', content: '你是实时情绪导航助手，用户说话时分析情绪，给温暖建议。' },
                { role: 'user', content: text }
              ]
            }
          })
        });
        const data = await response.json();
        return data.output.choices[0].message.content || "我在呢。";
      } catch (e) {
        addLog('系统', 'AI 调用失败：' + e.message, 'error');
        return "我在呢，网络有点慢，别急。";
      }
    }

    // 语音输出
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-CN';
      utter.rate = 0.9;
      utter.onend = () => addLog('系统', '语音播报完成');
      utter.onerror = (e) => addLog('系统', '语音播报失败：' + e.error, 'error');
      synth.speak(utter);
    }

    // 提取地点
    function extractAndNavigate(text) {
      const keywords = ['湖边', '公园', '咖啡馆', '家', '学校', '海边', '山上'];
      for (let kw of keywords) {
        if (text.includes(kw)) {
          nav.innerHTML = `<a href="https://uri.amap.com/navigation?to=${encodeURIComponent(kw)}" target="_blank" class="btn">
            一键导航到 ${kw}
          </a>`;
          return;
        }
      }
    }
  </script>
</body>
</html>
