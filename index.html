<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceMood Live</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; background: #f0f8ff; }
    h1 { color: #007acc; }
    #status { font-size: 18px; margin: 20px; }
    #log { margin: 20px; font-size: 16px; text-align: left; max-width: 90%; margin: 0 auto; }
    .ai { color: #007acc; }
    .user { color: #333; }
    #nav { margin: 20px; }
    .btn { padding: 12px 24px; font-size: 18px; background: #007acc; color: white; text-decoration: none; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>VoiceMood Live</h1>
  <p>说“开始测试”或“去湖边”，我实时陪你</p>
  <div id="status">正在监听...</div>
  <div id="log"></div>
  <div id="nav"></div>

  <script>
    // === API Key 贴这里 ===
    const API_KEY = 'sk-550f45f609c5430d81ac382c31a4fccb'; // ←←← 替换这里！

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;  // 持续监听
    recognition.interimResults = true; // 实时中间结果

    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const nav = document.getElementById('nav');
    const synth = window.speechSynthesis;

    let finalTranscript = '';
    let isThinking = false;

    // 关键词触发
    const TRIGGER_WORDS = ['开始测试', '去湖边', '好累', '导航', '去哪', '难受', '冷静', '开车', '助手'];

    recognition.onresult = async (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
          addLog('你', transcript);
        } else {
          interim += transcript;
        }
      }

      // 实时显示
      status.innerText = finalTranscript + interim;

      // 检测关键词
      const fullText = (finalTranscript + interim).toLowerCase();
      if (!isThinking && TRIGGER_WORDS.some(word => fullText.includes(word))) {
        isThinking = true;
        status.innerText = 'AI 思考中...';
        const reply = await callBailianAI(finalTranscript + interim);
        addLog('AI', reply);
        speak(reply);
        extractAndNavigate(reply);
        isThinking = false;
        finalTranscript = ''; // 清空，准备下一轮
      }
    };

    recognition.onerror = () => {
      status.innerText = '监听出错，重试中...';
      setTimeout(() => recognition.start(), 1000);
    };

    recognition.onend = () => recognition.start(); // 自动重启

    // 开始监听
    recognition.start();
    status.innerText = '实时监听中...';

    // 添加对话
    function addLog(speaker, text) {
      const div = document.createElement('div');
      div.className = speaker === 'AI' ? 'ai' : 'user';
      div.innerHTML = `<strong>${speaker}：</strong>${text}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    // 调用阿里百炼
    async function callBailianAI(text) {
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            input: {
              messages: [
                { role: 'system', content: '你是实时情绪导航助手，用户说话时分析情绪，给温暖建议。' },
                { role: 'user', content: text }
              ]
            }
          })
        });
        const data = await response.json();
        return data.output.choices[0].message.content;
      } catch (e) {
        return "我在呢，别急，网络有点慢。";
      }
    }

    // 语音输出
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-CN';
      utter.rate = 0.9;
      synth.speak(utter);
    }

    // 提取地点 → 高德
    function extractAndNavigate(text) {
      const keywords = ['湖边', '公园', '咖啡馆', '家', '学校', '海边', '山上'];
      for (let kw of keywords) {
        if (text.includes(kw)) {
          nav.innerHTML = `<a href="https://uri.amap.com/navigation?to=${encodeURIComponent(kw)}" target="_blank" class="btn">
            一键导航到 ${kw}
          </a>`;
          return;
        }
      }
    }
  </script>
</body>
</html>
