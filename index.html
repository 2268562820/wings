<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceMood Live</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; background: #f0f8ff; }
    h1 { color: #007acc; }
    #status { font-size: 18px; margin: 20px; color: #555; }
    #log { margin: 20px auto; max-width: 90%; text-align: left; border: 1px solid #ddd; padding: 10px; border-radius: 8px; max-height: 400px; overflow-y: auto; background: white; }
    .user { color: #333; margin: 8px 0; }
    .ai { color: #007acc; margin: 8px 0; font-weight: bold; }
    .system { color: #888; font-style: italic; }
    #nav { margin: 20px; }
    .btn { padding: 12px 24px; font-size: 18px; background: #007acc; color: white; text-decoration: none; border-radius: 8px; display: inline-block; }
  </style>
</head>
<body>
  <h1>VoiceMood Live</h1>
  <p>说“开始测试”或“去湖边”，我陪你</p>
  <div id="status">正在启动...</div>
  <div id="log"></div>
  <div id="nav"></div>

  <script>
    // === API Key 贴这里 ===
    const API_KEY = 'sk-550f45f609c5430d81ac382c31a4fccb'; // ←←← 替换这里！

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;
    recognition.interimResults = true;

    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const nav = document.getElementById('nav');
    const synth = window.speechSynthesis;

    let finalTranscript = '';
    let isThinking = false;
    let lastSpeechTime = Date.now();
    let careTimer = null;

    const TRIGGER_WORDS = ['开始测试', '去湖边', '好累', '导航', '去哪', '难受', '冷静', '开车', '助手', '帮我', '我想去'];
    const CARE_INTERVAL = 30000; // 30秒

    // 添加对话
    function addLog(speaker, text) {
      const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      const div = document.createElement('div');
      div.className = speaker === 'AI' ? 'ai' : (speaker === '系统' ? 'system' : 'user');
      div.innerHTML = `<small>${time}</small> <strong>${speaker}：</strong>${text}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    // 30秒没说话，关心你
    function startCareTimer() {
      clearTimeout(careTimer);
      careTimer = setTimeout(() => {
        const careMsg = "还活着吗？我在呢，说句话吧。";
        addLog('AI', careMsg);
        speak(careMsg);
      }, CARE_INTERVAL);
    }

    recognition.onstart = () => {
      status.innerText = '实时监听中...';
      addLog('系统', '语音引擎已启动');
      startCareTimer();
    };

    recognition.onresult = async (event) => {
      lastSpeechTime = Date.now(); // 你说话了，重置计时
      startCareTimer();

      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
          addLog('你', transcript);
        } else {
          interim += transcript;
        }
      }

      status.innerText = finalTranscript + interim;

      const fullText = (finalTranscript + interim).toLowerCase();
      if (!isThinking && TRIGGER_WORDS.some(word => fullText.includes(word))) {
        isThinking = true;
        status.innerText = 'AI 思考中...';
        addLog('系统', '检测到关键词，调用 AI...');

        const reply = await callBailianAI(finalTranscript + interim);
        addLog('AI', reply);
        speak(reply);
        extractAndNavigate(reply);

        isThinking = false;
        finalTranscript = '';
      }
    };

    recognition.onerror = (e) => {
      status.innerText = '语音错误，重试中...';
      addLog('系统', '语音识别出错：' + e.error);
      setTimeout(() => recognition.start(), 1000);
    };

    recognition.onend = () => recognition.start();

    // 启动
    recognition.start();

    // 调用阿里百炼
    async function callBailianAI(text) {
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            input: {
              messages: [
                { role: 'system', content: '你是实时情绪导航助手，用户说话时分析情绪，给温暖建议。' },
                { role: 'user', content: text }
              ]
            }
          })
        });
        const data = await response.json();
        return data.output.choices[0].message.content || "我在呢。";
      } catch (e) {
        addLog('系统', 'AI 调用失败：' + e.message);
        return "我在呢，网络有点慢，别急。";
      }
    }

    // 语音输出
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-CN';
      utter.rate = 0.9;
      utter.onend = () => addLog('系统', '语音播报完成');
      utter.onerror = () => addLog('系统', '语音播报失败');
      synth.speak(utter);
    }

    // 提取地点
    function extractAndNavigate(text) {
      const keywords = ['湖边', '公园', '咖啡馆', '家', '学校', '海边', '山上'];
      for (let kw of keywords) {
        if (text.includes(kw)) {
          nav.innerHTML = `<a href="https://uri.amap.com/navigation?to=${encodeURIComponent(kw)}" target="_blank" class="btn">
            一键导航到 ${kw}
          </a>`;
          return;
        }
      }
    }
  </script>
</body>
</html>
