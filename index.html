<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºè¡Œè¯­éŸ³åŠ©æ‰‹</title>
  <style>
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
    #result { margin: 20px 0; padding: 10px; border: 1px solid #ccc; min-height: 50px; }
  </style>
</head>
<body>
  <h1>å‡ºè¡Œè¯­éŸ³åŠ©æ‰‹</h1>
  <button id="startBtn">å¼€å§‹ä½¿ç”¨</button>
  <button id="stopBtn" disabled>æš‚åœä½¿ç”¨</button>
  <div id="result"></div>

  <script>
    // é…ç½®åŒºåŸŸï¼šæ›¿æ¢ä¸ºä½ çš„é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥å’Œè‡ªå®šä¹‰å…³é”®è¯
    const CONFIG = {
      DASHSCOPE_API_KEY: 'sk-550f45f609c5430d81ac382c31a4fccb', // ğŸ”´ å¿…é¡»æ›¿æ¢
      triggerWords: ['å¥½å›°', 'ç–²åŠ³äº†', 'æƒ³ç¡è§‰', 'çœ¼ç›é…¸', 'å¼€ä¸åŠ¨äº†', 'æ‰¾å……ç”µæ¡©', 'é™„è¿‘æœåŠ¡åŒº', 'å¼€å¯åŠ©æ‰‹'],
      responseMode: 'direct'
    };

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultEl = document.getElementById('result');
    let recognition;
    let isListening = false;

    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆChrome/Edgeæ”¯æŒï¼‰
    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        resultEl.textContent = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edge';
        return null;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'zh-CN';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        resultEl.textContent = transcript;

        // å…³é”®è¯è§¦å‘
        const hitWord = CONFIG.triggerWords.find(word => transcript.includes(word));
        if (hitWord) {
          callAliyunAPI(hitWord, transcript);
        }
      };

      recognition.onend = () => {
        if (isListening) recognition.start();
      };

      return recognition;
    }

    // è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼API
    async function callAliyunAPI(hitWord, fullText) {
      const prompt = `ä½ æ˜¯å…¨çƒé¡¶çº§çš„å‡ºè¡Œå®‰å…¨ä¸“å®¶ï¼Œç”¨æˆ·å½“å‰éœ€æ±‚ï¼š"${fullText}"ï¼Œå…³é”®è¯ã€${hitWord}ã€‘ï¼Œè¯·ç»™å‡ºç®€æ´ç²¾å‡†çš„å»ºè®®ï¼ˆ15-25å­—ï¼‰ã€‚`;
      
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.DASHSCOPE_API_KEY}`
          },
          body: JSON.stringify({
            model: 'qwen3-omni-flash',
            input: { prompt },
            parameters: { result_format: 'text', max_new_tokens: 60, temperature: 0.1 }
          })
        });

        const data = await response.json();
        if (data.output?.text) {
          resultEl.textContent = `AIå»ºè®®ï¼š${data.output.text}`;
        }
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        resultEl.textContent = 'APIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥å’Œç½‘ç»œ';
      }
    }

    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
    function startRecognition() {
      if (!recognition) initRecognition();
      if (recognition && !isListening) {
        isListening = true;
        recognition.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        resultEl.textContent = 'æ­£åœ¨è†å¬...';
      }
    }

    // æš‚åœè¯­éŸ³è¯†åˆ«
    function stopRecognition() {
      if (recognition && isListening) {
        isListening = false;
        recognition.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        resultEl.textContent = 'å·²æš‚åœè†å¬';
      }
    }

    // æŒ‰é’®äº‹ä»¶
    startBtn.addEventListener('click', startRecognition);
    stopBtn.addEventListener('click', stopRecognition);

    // åˆå§‹åŒ–
    initRecognition();
  </script>
</body>
</html>
