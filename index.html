<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交通辅助系统 - 基础版</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f0f0;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; margin-bottom: 20px; }
        button { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { 
            padding: 15px; 
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .safe { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .danger { background: #f8d7da; color: #721c24; }
        .objects { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>交通辅助系统</h1>
        
        <button id="startBtn">启动系统</button>
        <button id="stopBtn" disabled>停止系统</button>
        
        <div id="status" class="status">准备就绪</div>
        
        <div class="objects">
            <h3>检测到的物体:</h3>
            <div id="objectList"></div>
        </div>
    </div>

    <script>
        // 基础系统变量
        let isRunning = false;
        let aiModel = null;
        let cameraStream = null;
        let analysisInterval = null;
        
        // DOM元素
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const objectList = document.getElementById('objectList');
        
        // 启动系统
        startBtn.addEventListener('click', async () => {
            try {
                startBtn.disabled = true;
                updateStatus('正在加载AI模型...', 'warning');
                
                // 加载AI模型
                aiModel = await cocoSsd.load();
                
                // 请求摄像头权限
                updateStatus('请求摄像头权限...', 'warning');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // 开始分析
                startAnalysis();
                
                // 更新UI
                stopBtn.disabled = false;
                isRunning = true;
                updateStatus('系统运行中', 'safe');
                
            } catch (error) {
                console.error('启动失败:', error);
                updateStatus('启动失败: ' + error.message, 'danger');
                startBtn.disabled = false;
            }
        });
        
        // 停止系统
        stopBtn.addEventListener('click', () => {
            stopAnalysis();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            isRunning = false;
            updateStatus('系统已停止', 'warning');
        });
        
        // 开始环境分析
        function startAnalysis() {
            analysisInterval = setInterval(async () => {
                if (!aiModel) return;
                
                try {
                    // 创建临时视频元素分析画面
                    const video = document.createElement('video');
                    video.srcObject = cameraStream;
                    video.play();
                    
                    await new Promise(resolve => video.onloadeddata = resolve);
                    
                    // 检测物体
                    const predictions = await aiModel.detect(video);
                    
                    // 显示结果
                    displayObjects(predictions);
                    
                } catch (error) {
                    console.error('分析失败:', error);
                }
            }, 2000); // 每2秒分析一次
        }
        
        // 停止分析
        function stopAnalysis() {
            if (analysisInterval) clearInterval(analysisInterval);
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        }
        
        // 显示检测到的物体
        function displayObjects(predictions) {
            objectList.innerHTML = '';
            
            if (predictions.length === 0) {
                objectList.innerHTML = '<p>未检测到物体</p>';
                return;
            }
            
            predictions.forEach(pred => {
                const item = document.createElement('div');
                item.textContent = `${pred.class} (${Math.round(pred.score * 100)}%)`;
                objectList.appendChild(item);
            });
        }
        
        // 更新状态显示
        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            if (isRunning) stopAnalysis();
        });
    </script>
</body>
</html>
